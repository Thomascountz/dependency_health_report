#!/usr/bin/env ruby

require_relative "../dependency_health_report.rb"
require "optparse"
require "date"
require "bundler"
require "logger"


options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: dependency_health_report <Gemfile.lock> [options]"

  opts.on("--as-of DATE", "Analyze dependencies as of the given date (YYYY-MM-DD)") do |date|
    options[:as_of] = Date.parse(date)
  rescue ArgumentError
    puts "Invalid date format. Please use YYYY-MM-DD."
    exit 1
  end

  opts.on("--verbose", "Run with verbose logs") do
    options[:verbose] = true
  end
end.parse!

# Null logger unless verbose is specified
logger = options[:verbose] ? Logger.new($stdout) : Logger.new(nil)

lockfile_path = ARGV[0] || Bundler.default_lockfile

begin
lockfile_contents = File.read(lockfile_path)
rescue Errno::ENOENT
  logger.error("Lockfile not found at path: #{lockfile_path}")
  exit 1
end


as_of = options[:as_of] || nil

lockfile_parser = LockfileParser.new(logger:)
gem_info_fetcher = GemInfoFetcher.new(logger:)
dependency_analyzer = DependencyAnalyzer.new(logger:)
reporter = PlaintextReporter.new

DependencyHealthReport.new(lockfile_parser:, gem_info_fetcher:, dependency_analyzer:, reporter:, logger:).run(lockfile_contents, as_of: as_of)
